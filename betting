import sqlite3
import threading
import html
import logging
import time
import telebot
from telebot import types

BOT_TOKEN = "8369428332:AAFHD8US26N4Vy0f6Ii5uMW-P2ezebOZPxY"
OWNER_ID = 6332304335
DEVELOPER_ID = 6332304335
ADMIN_IDS = [6332304335, 6476181144]

DB_PATH = "vip_bet.db"
DIAMOND_RATE = 40
REF_BONUS = 40
BOT_USERNAME = "Betcodm_bot"

bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")
logging.basicConfig(level=logging.INFO)
db_lock = threading.Lock()


# ----------------- DATABASE -----------------
def init_db():
    with sqlite3.connect(DB_PATH) as conn:
        conn.executescript("""
        PRAGMA foreign_keys = ON;
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            diamonds INTEGER DEFAULT 0,
            created_at INTEGER
        );
        CREATE TABLE IF NOT EXISTS settings (
            key TEXT PRIMARY KEY,
            value TEXT
        );
        CREATE TABLE IF NOT EXISTS referrals (
            user_id INTEGER PRIMARY KEY,
            count INTEGER DEFAULT 0
        );
        CREATE TABLE IF NOT EXISTS ref_used (
            user_id INTEGER PRIMARY KEY,
            referrer_id INTEGER
        );
        """)
        conn.commit()

# ----------------- DB HELPERS -----------------
def ensure_user(uid: int):
    with db_lock, sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("INSERT OR IGNORE INTO users(user_id,diamonds,created_at) VALUES(?,?,?)", (uid, 0, int(time.time())))
        cur.execute("INSERT OR IGNORE INTO referrals(user_id,count) VALUES(?,0)", (uid,))
        conn.commit()

def get_balance(uid: int) -> int:
    ensure_user(uid)
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT diamonds FROM users WHERE user_id=?", (uid,))
        r = cur.fetchone()
        return int(r[0]) if r else 0

def change_balance(uid: int, delta: int):
    ensure_user(uid)
    with db_lock, sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("UPDATE users SET diamonds = diamonds + ? WHERE user_id=?", (delta, uid))
        conn.commit()

def set_setting(key: str, value: str):
    with db_lock, sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO settings(key,value) VALUES(?,?) ON CONFLICT(key) DO UPDATE SET value=excluded.value",(key,value))
        conn.commit()

def get_setting(key: str):
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT value FROM settings WHERE key=?", (key,))
        r = cur.fetchone()
        return r[0] if r else None

def add_referral(referrer_id: int):
    with db_lock, sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO referrals(user_id,count) VALUES(?,1) ON CONFLICT(user_id) DO UPDATE SET count=count+1",(referrer_id,))
        conn.commit()

def get_ref_count(uid: int) -> int:
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT count FROM referrals WHERE user_id=?", (uid,))
        r = cur.fetchone()
        return int(r[0]) if r else 0

def mark_ref_used(user_id: int, referrer_id: int):
    with db_lock, sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("INSERT OR IGNORE INTO ref_used(user_id,referrer_id) VALUES(?,?)", (user_id, referrer_id))
        conn.commit()

def has_used_ref(user_id: int):
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT referrer_id FROM ref_used WHERE user_id=?", (user_id,))
        r = cur.fetchone()
        return int(r[0]) if r else None

# ----------------- TEXT TEMPLATES -----------------
BALANCE_TEXT = "ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§:\nØ§Ù„Ù…Ø§Ø³ ğŸ’: {diamonds}\nØ¨Ù‡ ØªÙˆÙ…Ø§Ù†: {toman:,}"
FREE_DIAMOND_TEXT = (
    "ğŸ’ Ø¨Ø§ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯\n"
    "50 Ø§Ù„Ù…Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯! ÙÙ‚Ø· ØªØ§ Ø§Ù…Ø±ÙˆØ²..\n"
    "ğŸ‘¥ Ú©Ù„ Ø¯Ø¹ÙˆØªÛŒâ€ŒÙ‡Ø§: {count}\n"
    "ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: {link}"
)

# ----------------- HELPERS -----------------
def user_display_from_userobj(u):
    if not u:
        return "Ú©Ø§Ø±Ø¨Ø±"
    if getattr(u, "username", None):
        return f"@{u.username}"
    name = getattr(u, "first_name", None) or "Ú©Ø§Ø±Ø¨Ø±"
    return f"<a href='tg://user?id={u.id}'>{html.escape(name)}</a>"

def user_display_from_id(uid: int):
    try:
        u = bot.get_chat(uid)
        return user_display_from_userobj(u)
    except Exception:
        return f"<a href='tg://user?id={uid}'>Ú©Ø§Ø±Ø¨Ø±</a>"

def is_admin(uid: int) -> bool:
    return uid in ADMIN_IDS

def in_private(m): return m.chat.type == "private"
def in_group(m): return m.chat.type in ("group","supergroup")

# ----------------- START & REFERRAL -----------------
@bot.message_handler(commands=['start'])
def cmd_start(m: types.Message):
    args = m.text.split()
    inviter_id = None
    if len(args) > 1:
        try:
            inviter_id = int(args[1])
        except:
            inviter_id = None
    user_id = m.from_user.id
    ensure_user(user_id)

    if inviter_id and inviter_id != user_id and not has_used_ref(user_id):
        change_balance(inviter_id, REF_BONUS)
        add_referral(inviter_id)
        mark_ref_used(user_id, inviter_id)
        try:
            bot.send_message(user_id, f"ğŸ’ Ø¨Ø§ ØªØ´Ú©Ø± Ø§Ø² Ø¯Ø¹ÙˆØª! Ø¨Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÛŒ Ø´Ù…Ø§ {REF_BONUS} Ø§Ù„Ù…Ø§Ø³ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.")
        except:
            pass
        try:
            bot.send_message(inviter_id, f"âœ… ÛŒÚ© Ù†ÙØ± Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ø´Ø¯ Ùˆ {REF_BONUS} Ø§Ù„Ù…Ø§Ø³ Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.")
        except:
            pass

    if in_private(m):
        text = get_setting("start_text") or "Ø³Ù„Ø§Ù… ğŸ‘‹\nØ¨Ù‡ Ø±Ø¨Ø§Øª VIP Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ğŸŒŸ\nØ§Ø² Ù…Ù†Ùˆ Ø²ÛŒØ± Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."
        photo_id = get_setting("start_photo")
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.row("â‰¼ Ø³Ù€Ù„Ù€ÙÙ€ ğ•ğ¢ğ â‰½", "â‰¼ Ø®Ù€Ø¯Ù…Ù€Ø§ØªÙ€ ğ•ğ¢ğ â‰½")
        markup.row("â‰¼ Ø´Ù€Ø§Ø±Ú˜ Ù…Ù€ÙˆØ¬Ù€ÙˆØ¯ÛŒ ğŸ’³ â‰½", "â‰¼ Ø§Ù„Ù…Ø§Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù† â‰½")
        if photo_id:
            try:
                bot.send_photo(m.chat.id, photo_id, caption=text, reply_markup=markup)
            except:
                bot.send_message(m.chat.id, text, reply_markup=markup)
        else:
            bot.send_message(m.chat.id, text, reply_markup=markup)

# ----------------- ADMIN GIVE / REMOVE -----------------
@bot.message_handler(commands=['give'])
def cmd_give(m: types.Message):
    if not is_admin(m.from_user.id):
        return bot.reply_to(m, "Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
    try:
        if m.reply_to_message:
            target = m.reply_to_message.from_user.id
            amount = int(m.text.split()[1])
        else:
            parts = m.text.split()
            target = int(parts[1])
            amount = int(parts[2])
    except:
        return bot.reply_to(m, "ÙØ±Ù…Øª: Ø±ÛŒÙ¾Ù„Ø§ÛŒ + /give <amount> ÛŒØ§ /give <user_id> <amount>")
    change_balance(target, amount)
    bot.reply_to(m, f"âœ… {amount} Ø§Ù„Ù…Ø§Ø³ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± {target} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")

@bot.message_handler(commands=['remove'])
def cmd_remove(m: types.Message):
    if not is_admin(m.from_user.id):
        return bot.reply_to(m, "Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
    try:
        if m.reply_to_message:
            target = m.reply_to_message.from_user.id
            amount = int(m.text.split()[1])
        else:
            parts = m.text.split()
            target = int(parts[1])
            amount = int(parts[2])
    except:
        return bot.reply_to(m, "ÙØ±Ù…Øª: Ø±ÛŒÙ¾Ù„Ø§ÛŒ + /remove <amount> ÛŒØ§ /remove <user_id> <amount>")
    bal = get_balance(target)
    if amount > bal:
        amount = bal
    change_balance(target, -amount)
    bot.reply_to(m, f"âœ… {amount} Ø§Ù„Ù…Ø§Ø³ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {target} Ú©Ø³Ø± Ø´Ø¯.")
    
# ----------------- TRANSFER DIAMONDS (GROUP ONLY) -----------------
@bot.message_handler(func=lambda message: message.text and message.text.startswith("Ø§Ù†ØªÙ‚Ø§Ù„"))
def transfer_diamonds(message):
    if message.chat.type not in ["group", "supergroup"]:
        bot.reply_to(message, "âŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª.")
        return

    parts = message.text.split()
    if len(parts) < 2:
        bot.reply_to(
            message,
            "ğŸ“‹ ÙØ±Ù…Øª Ø¯Ø±Ø³Øª:\nØ±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:\n<b>Ø§Ù†ØªÙ‚Ø§Ù„ Û²Û°</b>\nÛŒØ§\n<b>Ø§Ù†ØªÙ‚Ø§Ù„ Û²Û° 123456789</b>",
            parse_mode="HTML"
        )
        return

    try:
        amount = int(parts[1])
        if amount <= 0:
            raise ValueError
    except ValueError:
        bot.reply_to(message, "âŒ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„Ù…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯.")
        return

    # Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡
    receiver_id = None
    if message.reply_to_message:
        receiver_id = message.reply_to_message.from_user.id
    elif len(parts) >= 3 and parts[2].isdigit():
        receiver_id = int(parts[2])

    if not receiver_id:
        bot.reply_to(message, "âŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª.\nØ±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.")
        return

    sender_id = message.from_user.id
    if sender_id == receiver_id:
        bot.reply_to(message, "âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø§Ù„Ù…Ø§Ø³ Ø¨ÙØ±Ø³ØªÛŒØ¯.")
        return

    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡
    tax = int(amount * 0.05)
    total_cost = amount + tax  # Ù…Ø¨Ù„ØºÛŒ Ú©Ù‡ Ø§Ø² ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯

    sender_balance = get_balance(sender_id)
    if sender_balance < total_cost:
        bot.reply_to(message, f"âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.\nØ´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ {amount} Ø§Ù„Ù…Ø§Ø³ØŒ Ø¨Ø§ÛŒØ¯ {total_cost} Ø§Ù„Ù…Ø§Ø³ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯ (Ø´Ø§Ù…Ù„ Ù…Ø§Ù„ÛŒØ§Øª ÛµÙª).")
        return

    # Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø§Ø³
    change_balance(sender_id, -total_cost)
    change_balance(receiver_id, amount)

    sender_name = message.from_user.username or message.from_user.first_name or f"Ú©Ø§Ø±Ø¨Ø± {sender_id}"

    # Ø±Ø³ÛŒØ¯
    receipt = (
        f"ğŸ’ Ø±Ø³ÛŒØ¯ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø§Ø³\n"
        f"ğŸ‘¤ ÙØ±Ø³ØªÙ†Ø¯Ù‡: <b>{sender_name}</b>\n"
        f"ğŸ‘¥ Ú¯ÛŒØ±Ù†Ø¯Ù‡: <code>{receiver_id}</code>\n"
        f"ğŸ’µ Ù…Ø¨Ù„Øº Ø§Ø±Ø³Ø§Ù„: {amount}\n"
        f"ğŸ§¾ Ù…Ø§Ù„ÛŒØ§Øª Ø§Ø² ÙØ±Ø³ØªÙ†Ø¯Ù‡: {tax}\n"
        f"âœ… Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡: {amount}"
    )
    bot.reply_to(message, receipt, parse_mode="HTML")

    # Ù¾ÛŒØ§Ù… Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú¯ÛŒØ±Ù†Ø¯Ù‡
    try:
        bot.send_message(
            receiver_id,
            f"ğŸ‰ ØªØ¨Ø±ÛŒÚ©!\nØ´Ù…Ø§ <b>{amount}</b> Ø§Ù„Ù…Ø§Ø³ Ø§Ø² <b>{sender_name}</b> Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯.",
            parse_mode="HTML"
        )
    except:
        pass
        
# ================== BET SECTION (FIXED: RLock + early answer) ==================

import random
import sqlite3
import threading
import time
from telebot import types

MIN_BET = 20
BET_TAX_PERCENT = 2
DB_PATH = "vip_bet.db"
# IMPORTANT: ensure at top-of-file you set: db_lock = threading.RLock()
# (not Lock). If not, replace existing db_lock definition with RLock.
# db_lock = threading.RLock()

# Ø¬Ø¯ÙˆÙ„ bets Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯
def init_bets_table():
    with sqlite3.connect(DB_PATH) as conn:
        conn.execute("""
        CREATE TABLE IF NOT EXISTS bets (
            bet_id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER,
            creator_id INTEGER,
            amount INTEGER,
            state TEXT,
            player_joined_id INTEGER,
            message_id INTEGER,
            created_at INTEGER
        )
        """)
        conn.commit()

init_bets_table()

# Ù…ØªÙ†â€ŒÙ‡Ø§
BET_OPEN_TEXT = (
    "â—ˆ â”â”â”â” ğ•ğˆğ â”â”â”â”â” â—ˆ\n"
    "Ø´Ø±Ø·Ø¨Ù†Ø¯ÛŒ Ø¨Ø§Ø² Ø´Ø¯:\n"
    "ğŸ’ Ø§Ù„Ù…Ø§Ø³: {amount}\n"
    "ğŸ‘¤ Ø³Ø§Ø²Ù†Ø¯Ù‡: {creator}\n"
    "â—ˆ â”â”â”â” ğ•ğˆğ â”â”â”â”â” â—ˆ"
)
BET_RESULT_TEXT = (
    "â—ˆâ”â”â”â”â”â” ğ•ğˆğ â”â”â”â”â”â” â—ˆ\n"
    "Ù†ØªÛŒØ¬Ù‡ Ø´Ø±Ø·Ø¨Ù†Ø¯ÛŒ:\n"
    "ğŸ† Ø¨Ø±Ù†Ø¯Ù‡: {winner}\n"
    "ğŸ’€ Ø¨Ø§Ø²Ù†Ø¯Ù‡: {loser}\n"
    "ğŸ’ Ø¬Ø§ÛŒØ²Ù‡: {prize}\n"
    "ğŸ§¾ Ù…Ø§Ù„ÛŒØ§Øª: {tax}\n"
    "â—ˆâ”â”â”â”â”â” ğ•ğˆğ â”â”â”â”â”â” â—ˆ"
)

def bet_keyboard(bet_id: int, creator_id: int):
    kb = types.InlineKeyboardMarkup()
    kb.add(
        types.InlineKeyboardButton("Ù„ØºÙˆ âŒ", callback_data=f"bet:cancel:{bet_id}:{creator_id}"),
        types.InlineKeyboardButton("Ù¾ÛŒÙˆØ³ØªÙ† âœ…", callback_data=f"bet:join:{bet_id}")
    )
    return kb

@bot.message_handler(func=lambda m: m.text and m.text.startswith("Ø´Ø±Ø·Ø¨Ù†Ø¯ÛŒ"))
def cmd_bet(m):
    try:
        amount = int(m.text.split()[1])
    except:
        return bot.reply_to(m, f"ÙØ±Ù…Øª: Ø´Ø±Ø·Ø¨Ù†Ø¯ÛŒ <Ù…Ù‚Ø¯Ø§Ø±> (Ø­Ø¯Ø§Ù‚Ù„ {MIN_BET} ğŸ’)")

    if amount < MIN_BET:
        return bot.reply_to(m, f"Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· {MIN_BET} ğŸ’ Ø§Ø³Øª.")

    user_id = m.from_user.id
    bal = get_balance(user_id)
    if bal < amount:
        return bot.reply_to(m, "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")

    # Ú©Ù… Ú©Ø±Ø¯Ù† Ø§Ø² Ú©Ø§Ø±Ø¨Ø± (Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø®ÙˆØ¯Ø´ Ø§Ø² db_lock Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
    change_balance(user_id, -amount)

    # Ø«Ø¨Øª Ø´Ø±Ø· Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ â€” ÙÙ‚Ø· Ù‡Ù†Ú¯Ø§Ù… Ù†ÙˆØ´ØªÙ† Ø¨Ù‡ DB Ù‚ÙÙ„ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
    with db_lock:
        with sqlite3.connect(DB_PATH) as conn:
            cur = conn.cursor()
            cur.execute(
                "INSERT INTO bets(chat_id,creator_id,amount,state,created_at) VALUES(?,?,?,?,?)",
                (m.chat.id, user_id, amount, "open", int(time.time()))
            )
            bet_id = cur.lastrowid
            conn.commit()

    text = BET_OPEN_TEXT.format(amount=amount, creator=user_display_from_id(user_id))
    kb = bet_keyboard(bet_id, user_id)

    # Ù¾ÛŒØ§Ù… Ø´Ø±Ø· (Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹â€ŒÚ©Ù†Ù†Ø¯Ù‡)
    msg = bot.send_message(m.chat.id, text, reply_markup=kb, reply_to_message_id=m.message_id)

    # Ø°Ø®ÛŒØ±Ù‡ message_id
    with db_lock:
        with sqlite3.connect(DB_PATH) as conn:
            cur = conn.cursor()
            cur.execute("UPDATE bets SET message_id=? WHERE bet_id=?", (msg.message_id, bet_id))
            conn.commit()


@bot.callback_query_handler(func=lambda c: c.data and c.data.startswith("bet:"))
def cb_bet(c):
    # Ø¬ÙˆØ§Ø¨ Ú©ÙˆØªØ§Ù‡ ÙÙˆØ±ÛŒ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ØªØ§ Ø¯Ú©Ù…Ù‡ "Ù…Ø´ØºÙˆÙ„" Ù†Ø´Ù‡
    try:
        bot.answer_callback_query(c.id)
    except:
        pass

    try:
        parts = c.data.split(":")
        action = parts[1]
        bet_id = int(parts[2])
    except Exception as e:
        # invalid callback data
        try:
            bot.answer_callback_query(c.id, "âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.")
        except:
            pass
        return

    try:
        # Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø±Ø· (Ø¨Ø¯ÙˆÙ† Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ù„Ø§Ú© Ø·ÙˆÙ„Ø§Ù†ÛŒ)
        with db_lock:
            with sqlite3.connect(DB_PATH) as conn:
                cur = conn.cursor()
                cur.execute("SELECT creator_id, amount, state, player_joined_id, message_id FROM bets WHERE bet_id=?", (bet_id,))
                row = cur.fetchone()

        if not row:
            return bot.answer_callback_query(c.id, "Ø´Ø±Ø· Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")

        creator_id, amount, state, joined_id, message_id = row
        user_id = c.from_user.id

        # --- HANDLE CANCEL ---
        if action == "cancel":
            if user_id != creator_id:
                return bot.answer_callback_query(c.id, "ÙÙ‚Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù„ØºÙˆ Ú©Ù†Ø¯.")
            if state != "open":
                return bot.answer_callback_query(c.id, "Ø§ÛŒÙ† Ø´Ø±Ø· Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.")

            # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø³Ø§Ø²Ù†Ø¯Ù‡ â€” change_balance Ø®ÙˆØ¯Ø´ Ù‚ÙÙ„ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ (RLock)
            change_balance(creator_id, amount)

            # Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø´Ø±Ø· Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† cancelled
            with db_lock:
                with sqlite3.connect(DB_PATH) as conn:
                    cur = conn.cursor()
                    cur.execute("UPDATE bets SET state='cancelled' WHERE bet_id=?", (bet_id,))
                    conn.commit()

            # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø´Ø±Ø· (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² message_id Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡)
            try:
                bot.edit_message_text("âŒ Ø§ÛŒÙ† Ø´Ø±Ø· ØªÙˆØ³Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù„ØºÙˆ Ø´Ø¯.", c.message.chat.id, message_id)
            except Exception:
                # fallback: Ø§Ú¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² c.message Ù…Ø´Ú©Ù„ Ø¯Ø§Ø´ØªØŒ ØªÙ„Ø§Ø´ Ø¨Ø§ chat_id/message_id Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡
                try:
                    bot.edit_message_text("âŒ Ø§ÛŒÙ† Ø´Ø±Ø· ØªÙˆØ³Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù„ØºÙˆ Ø´Ø¯.", c.message.chat.id, message_id)
                except:
                    pass

            return bot.answer_callback_query(c.id, "Ø´Ø±Ø· Ù„ØºÙˆ Ø´Ø¯.")

        # --- HANDLE JOIN ---
        elif action == "join":
            # Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¯Ø± Ù„Ø­Ø¸Ù‡Ù” Ù¾ÛŒÙˆØ³ØªÙ† (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² race)
            with db_lock:
                with sqlite3.connect(DB_PATH) as conn:
                    cur = conn.cursor()
                    cur.execute("SELECT creator_id, amount, state, player_joined_id, message_id FROM bets WHERE bet_id=?", (bet_id,))
                    row2 = cur.fetchone()
            if not row2:
                return bot.answer_callback_query(c.id, "Ø´Ø±Ø· Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
            creator_id, amount, state, joined_id, message_id = row2

            if state != "open":
                return bot.answer_callback_query(c.id, "Ø§ÛŒÙ† Ø´Ø±Ø· Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
            if joined_id:
                return bot.answer_callback_query(c.id, "ÛŒÚ© Ù†ÙØ± Ù‚Ø¨Ù„Ø§Ù‹ Ù¾ÛŒÙˆØ³ØªÙ‡ Ø§Ø³Øª.")
            if user_id == creator_id:
                return bot.answer_callback_query(c.id, "Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±ÙˆÛŒ Ø´Ø±Ø· Ø®ÙˆØ¯ØªØ§Ù† Ø´Ø±Ú©Øª Ú©Ù†ÛŒØ¯.")

            bal = get_balance(user_id)
            if bal < amount:
                return bot.answer_callback_query(c.id, "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")

            # Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÙˆÙ… (Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù‚ÙÙ„ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
            change_balance(user_id, -amount)

            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª Ùˆ Ø¬Ø§ÛŒØ²Ù‡
            tax = (amount * 2 * BET_TAX_PERCENT) // 100
            prize = amount * 2 - tax

            # Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø±Ù†Ø¯Ù‡
            winner_id = random.choice([creator_id, user_id])
            loser_id = creator_id if winner_id == user_id else user_id

            # ÙˆØ§Ø±ÛŒØ² Ø¬Ø§ÛŒØ²Ù‡ Ø¨Ù‡ Ø¨Ø±Ù†Ø¯Ù‡
            change_balance(winner_id, prize)

            # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø±Ø·
            with db_lock:
                with sqlite3.connect(DB_PATH) as conn:
                    cur = conn.cursor()
                    cur.execute("UPDATE bets SET state='closed', player_joined_id=? WHERE bet_id=?", (user_id, bet_id))
                    conn.commit()

            # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù†ØªÛŒØ¬Ù‡
            text = BET_RESULT_TEXT.format(
                winner=user_display_from_id(winner_id),
                loser=user_display_from_id(loser_id),
                prize=prize,
                tax=tax
            )
            try:
                bot.edit_message_text(text, c.message.chat.id, message_id)
            except Exception:
                try:
                    bot.edit_message_text(text, c.message.chat.id, message_id)
                except:
                    pass

            return bot.answer_callback_query(c.id, "Ø´Ø±Ø·Ø¨Ù†Ø¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!")

    except Exception as e:
        # Ù„Ø§Ú¯ Ú©Ù† Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ (print ÛŒØ§ logging)
        print("Bet Callback Error:", repr(e))
        try:
            bot.answer_callback_query(c.id, "âŒ Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        except:
            pass

# ----------------- PRIVATE MENU -----------------
@bot.message_handler(func=lambda m: in_private(m) and isinstance(m.text, str) and m.text.strip() in [
    "â‰¼ Ø³Ù€Ù„Ù€ÙÙ€ ğ•ğ¢ğ â‰½", "â‰¼ Ø®Ù€Ø¯Ù…Ù€Ø§ØªÙ€ ğ•ğ¢ğ â‰½", "â‰¼ Ø´Ù€Ø§Ø±Ú˜ Ù…Ù€ÙˆØ¬Ù€ÙˆØ¯ÛŒ ğŸ’³ â‰½", "â‰¼ Ø§Ù„Ù…Ø§Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù† â‰½"
])
def private_menu(m: types.Message):
    txt = m.text.strip()
    if txt in ("â‰¼ Ø³Ù€Ù„Ù€ÙÙ€ ğ•ğ¢ğ â‰½", "â‰¼ Ø®Ù€Ø¯Ù…Ù€Ø§ØªÙ€ ğ•ğ¢ğ â‰½"):
        return bot.reply_to(m, "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ø¯ÛŒØª...")
    if txt == "â‰¼ Ø´Ù€Ø§Ø±Ú˜ Ù…Ù€ÙˆØ¬Ù€ÙˆØ¯ÛŒ ğŸ’³ â‰½":
        return bot.reply_to(m, "Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¨Ù‡ Ø¢ÛŒØ¯ÛŒ Ø²ÛŒØ± Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯:\n@Mr_oXin01")
    if txt == "â‰¼ Ø§Ù„Ù…Ø§Ø³ Ø±Ø§ÛŒÚ¯Ø§Ù† â‰½":
        count = get_ref_count(m.from_user.id)
        link = f"https://t.me/{BOT_USERNAME}?start={m.from_user.id}"
        return bot.reply_to(m, FREE_DIAMOND_TEXT.format(count=count, link=link))

# ----------------- BALANCE (Ø±ÛŒÙ¾Ù„Ø§ÛŒ + Ø¹Ú©Ø³) -----------------
@bot.message_handler(func=lambda m: isinstance(m.text, str) and m.text.strip() == "Ù…ÙˆØ¬ÙˆØ¯ÛŒ")
def cmd_balance(m: types.Message):
    user_id = m.from_user.id
    bal = get_balance(user_id)
    text = BALANCE_TEXT.format(diamonds=bal, toman=bal * DIAMOND_RATE)
    game_photo = get_setting("game_photo")

    if game_photo:
        try:
            bot.send_photo(
                chat_id=m.chat.id,
                photo=game_photo,
                caption=text,
                reply_to_message_id=m.message_id
            )
        except:
            bot.reply_to(m, text)
    else:
        bot.reply_to(m, text)

# ----------------- MAIN -----------------
if __name__ == "__main__":
    init_db()
    print("âœ… VIP Bot v18 Ø±Ø§Ù† Ø´Ø¯ (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø·â€ŒØ¨Ù†Ø¯ÛŒ).")
    bot.infinity_polling()
    
